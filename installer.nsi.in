; NSIS installer script for re3-installer.
; This installer will guide users through installing GTA III/VC files for re3.

!include "MUI2.nsh"
!include "FileFunc.nsh"
!include "LogicLib.nsh"

; Basic installer information.
Name "re3-installer"
OutFile "re3-installer-@CMAKE_PROJECT_VERSION@-setup.exe"
InstallDir "$APPDATA\re3"
InstallDirRegKey HKCU "Software\re3" "Install_Dir"
RequestExecutionLevel highest

; Variables.
Var Disc1Path
Var Disc2Path
Var ErrorOccurred
Var InstallSize
Var Disc1TextField
Var Disc2TextField
Var IsAdmin

; MUI Settings.
!define MUI_ABORTWARNING
!define MUI_ICON "${NSISDIR}\Contrib\Graphics\Icons\modern-install.ico"
!define MUI_UNICON "${NSISDIR}\Contrib\Graphics\Icons\modern-uninstall.ico"

; Welcome page.
!insertmacro MUI_PAGE_WELCOME

; License page.
!insertmacro MUI_PAGE_LICENSE "@CMAKE_SOURCE_DIR@\LICENSE.txt"

; Custom page for Disc selection.
!define MUI_PAGE_HEADER_TEXT "Disc Selection"
!define MUI_PAGE_HEADER_SUBTEXT "Choose the location of your GTA III/VC disc images or folders."
Page custom DiscSelectionPage DiscSelectionPageLeave
!undef MUI_PAGE_HEADER_TEXT
!undef MUI_PAGE_HEADER_SUBTEXT

; Installation directory page.
!insertmacro MUI_PAGE_DIRECTORY

; Installation page.
!insertmacro MUI_PAGE_INSTFILES

; Finish page.
!insertmacro MUI_PAGE_FINISH

; Uninstaller pages.
!insertmacro MUI_UNPAGE_CONFIRM
!insertmacro MUI_UNPAGE_INSTFILES

; Languages.
!insertmacro MUI_LANGUAGE "English"

; Initialization function to set installation directory based on admin status.
Function .onInit
  UserInfo::GetAccountType
  Pop $0
  ${If} $0 == "Admin"
    ; Running as admin, use Program Files.
    StrCpy $IsAdmin "1"
    ; Check if there's a previous installation in HKLM.
    StrCpy $1 ""
    ReadRegStr $1 HKLM "Software\re3" "Install_Dir"
    ${If} $1 != ""
      StrCpy $INSTDIR $1
    ${Else}
      StrCpy $INSTDIR "$PROGRAMFILES\re3"
    ${EndIf}
  ${Else}
    ; If running as user, use AppData.
    StrCpy $IsAdmin "0"
    ; Check if there's a previous installation in HKCU.
    StrCpy $1 ""
    ReadRegStr $1 HKCU "Software\re3" "Install_Dir"
    ${If} $1 != ""
      StrCpy $INSTDIR $1
    ${Else}
      StrCpy $INSTDIR "$APPDATA\re3"
    ${EndIf}
  ${EndIf}
FunctionEnd

; Custom page for disc selection.
Function DiscSelectionPage
  !insertmacro MUI_HEADER_TEXT "Source Selection" "Choose the location of your GTA III/VC disc images or folders."
  
  nsDialogs::Create 1018
  Pop $0
  ${If} $0 == error
    Abort
  ${EndIf}

  ; Disc 1 section
  ${NSD_CreateLabel} 0 0 100% 12u "Disc 1 (ISO file or directory):"
  Pop $0

  ${NSD_CreateText} 0 15u 100% 12u "$Disc1Path"
  Pop $Disc1TextField

  ${NSD_CreateButton} 0 30u 49% 14u "Browse File..."
  Pop $1
  ${NSD_OnClick} $1 Disc1BrowseFile

  ${NSD_CreateButton} 51% 30u 49% 14u "Browse Folder..."
  Pop $2
  ${NSD_OnClick} $2 Disc1BrowseFolder

  ; Disc 2 section
  ${NSD_CreateLabel} 0 55u 100% 12u "Disc 2 (ISO file or directory with Audio folder):"
  Pop $0

  ${NSD_CreateText} 0 70u 100% 12u "$Disc2Path"
  Pop $Disc2TextField

  ${NSD_CreateButton} 0 85u 49% 14u "Browse File..."
  Pop $3
  ${NSD_OnClick} $3 Disc2BrowseFile

  ${NSD_CreateButton} 51% 85u 49% 14u "Browse Folder..."
  Pop $4
  ${NSD_OnClick} $4 Disc2BrowseFolder

  nsDialogs::Show
FunctionEnd

Function Disc1BrowseFile
  nsDialogs::SelectFileDialog open "$Disc1Path" "ISO Files (*.iso)|*.iso|All Files (*.*)|*.*"
  Pop $0
  ${If} $0 != ""
    StrCpy $Disc1Path $0
    ${NSD_SetText} $Disc1TextField $Disc1Path
  ${EndIf}
FunctionEnd

Function Disc1BrowseFolder
  nsDialogs::SelectFolderDialog "Select disc 1 directory" "$Disc1Path"
  Pop $0
  ${If} $0 != ""
    StrCpy $Disc1Path $0
    ${NSD_SetText} $Disc1TextField $Disc1Path
  ${EndIf}
FunctionEnd

Function Disc2BrowseFile
  nsDialogs::SelectFileDialog open "$Disc2Path" "ISO Files (*.iso)|*.iso|All Files (*.*)|*.*"
  Pop $0
  ${If} $0 != ""
    StrCpy $Disc2Path $0
    ${NSD_SetText} $Disc2TextField $Disc2Path
  ${EndIf}
FunctionEnd

Function Disc2BrowseFolder
  nsDialogs::SelectFolderDialog "Select disc 2 directory" "$Disc2Path"
  Pop $0
  ${If} $0 != ""
    StrCpy $Disc2Path $0
    ${NSD_SetText} $Disc2TextField $Disc2Path
  ${EndIf}
FunctionEnd

Function DiscSelectionPageLeave
  ${NSD_GetText} $Disc1TextField $Disc1Path
  ${NSD_GetText} $Disc2TextField $Disc2Path

  ${If} $Disc1Path == ""
    MessageBox MB_OK|MB_ICONEXCLAMATION "Please select a path for Disc 1."
    Abort
  ${EndIf}

  ${If} $Disc2Path == ""
    MessageBox MB_OK|MB_ICONEXCLAMATION "Please select a path for Disc 2."
    Abort
  ${EndIf}

  IfFileExists "$Disc1Path" +3 0
    MessageBox MB_OK|MB_ICONEXCLAMATION "The specified path for Disc 1 does not exist."
    Abort

  IfFileExists "$Disc2Path" +3 0
    MessageBox MB_OK|MB_ICONEXCLAMATION "The specified path for Disc 2 does not exist."
    Abort
FunctionEnd

; Installation section.
Section "Install" SecInstall
  StrCpy $ErrorOccurred "0"

  ; Check if installation directory already exists with content.
  IfFileExists "$INSTDIR\*.*" 0 +3
    MessageBox MB_YESNO|MB_ICONQUESTION "The installation directory already contains files. Continue anyway? (Not recommended)" IDYES +2
    Abort

  ; If $INSTDIR already exists, take a pre-installation inventory.
  IfFileExists "$INSTDIR" 0 +3
    DetailPrint "Taking pre-installation inventory..."
    nsExec::ExecToLog 'cmd /c dir /s /b "$INSTDIR" > "$TEMP\re3_pre_inventory.txt" 2>nul'

  ; Create installation directory.
  CreateDirectory "$INSTDIR"

  ; Use NSIS's plugin directory for temporary files (unique per installation).
  InitPluginsDir
  SetOutPath "$PLUGINSDIR"

  ; Extract re3-installer.exe to temporary directory.
  File "@CMAKE_BINARY_DIR@\src\re3-installer.exe"

  ; Extract required DLLs from the prefix/bin directory.
  ; Note: These files are optional and may not exist depending on build configuration.
  File /nonfatal "@CMAKE_INSTALL_PREFIX@\bin\libcdio-*.dll"
  File /nonfatal "@CMAKE_INSTALL_PREFIX@\bin\libiso9660-*.dll"
  File /nonfatal "@CMAKE_INSTALL_PREFIX@\bin\libunshield-*.dll"
  File /nonfatal "@CMAKE_INSTALL_PREFIX@\bin\libiconv-*.dll"
  File /nonfatal "@CMAKE_INSTALL_PREFIX@\bin\libwinpthread-*.dll"
  File /nonfatal "@CMAKE_INSTALL_PREFIX@\bin\zlib*.dll"

  DetailPrint "Running re3-installer..."
  DetailPrint "Disc 1: $Disc1Path"
  DetailPrint "Disc 2: $Disc2Path"
  DetailPrint "Install Directory: $INSTDIR"

  ; Execute re3-installer.exe with the provided paths.
  ClearErrors
  nsExec::ExecToLog '"$PLUGINSDIR\re3-installer.exe" "$Disc1Path" "$Disc2Path" "$INSTDIR"'
  Pop $0

  ; Check if the installation was successful.
  ${If} $0 != 0
    StrCpy $ErrorOccurred "1"
    DetailPrint "Installation failed with error code $0. Cleaning up..."
    MessageBox MB_OK|MB_ICONEXCLAMATION "Installation failed with error code $0. Only newly created files will be removed."
    ; Take a post-failure inventory and remove only new files.
    nsExec::ExecToLog 'cmd /c dir /s /b "$INSTDIR" > "$TEMP\re3_post_inventory.txt" 2>nul'
    ; Use PowerShell to compare and delete files (more reliable than batch).
    IfFileExists "$TEMP\re3_pre_inventory.txt" 0 NoPreInvRollback
      nsExec::ExecToLog 'powershell -Command "$post = Get-Content \"$TEMP\re3_post_inventory.txt\"; $pre = Get-Content \"$TEMP\re3_pre_inventory.txt\"; Compare-Object $pre $post | Where-Object {$_.SideIndicator -eq '=>'} | ForEach-Object {Remove-Item $_.InputObject -Force -ErrorAction SilentlyContinue}"'
      Goto CleanupDirs
    NoPreInvRollback:
    ; If no pre-inventory, remove only newly created directories.
    CleanupDirs:
    ; Remove empty directories.
    RMDir "$INSTDIR\data"
    RMDir "$INSTDIR\models"
    RMDir "$INSTDIR\audio"
    RMDir "$INSTDIR\anim"
    RMDir "$INSTDIR\txd"
    RMDir "$INSTDIR\text"
    Delete "$TEMP\re3_pre_inventory.txt"
    Delete "$TEMP\re3_post_inventory.txt"
    Goto InstallEnd
  ${EndIf}

  DetailPrint "Installation completed successfully."

  ; Take a post-installation inventory and create a list of installed files.
  DetailPrint "Creating installation inventory..."
  nsExec::ExecToLog 'cmd /c dir /s /b "$INSTDIR" > "$TEMP\re3_post_inventory.txt" 2>nul'
  
  ; Create the installed files list (excluding pre-existing files).
  IfFileExists "$TEMP\re3_pre_inventory.txt" HasPreInventory NoPreInventory
  
  HasPreInventory:
    ; Compare inventories and save only new files using PowerShell.
    nsExec::ExecToLog 'powershell -Command "$post = Get-Content \"$TEMP\re3_post_inventory.txt\"; $pre = Get-Content \"$TEMP\re3_pre_inventory.txt\"; Compare-Object $pre $post | Where-Object {$_.SideIndicator -eq '=>'} | ForEach-Object {$_.InputObject} | Out-File \"$INSTDIR\.re3_installed_files.txt\" -Encoding ASCII"'
    Delete "$TEMP\re3_pre_inventory.txt"
    Goto InventoryDone
  
  NoPreInventory:
    ; All files in post-inventory are new.
    CopyFiles "$TEMP\re3_post_inventory.txt" "$INSTDIR\.re3_installed_files.txt"
  
  InventoryDone:
  Delete "$TEMP\re3_post_inventory.txt"
  DetailPrint "Installation inventory created."

  ; Note: $PLUGINSDIR is automatically cleaned up by NSIS when the installer exits.

  ; Write registry keys for uninstaller
  ${If} $IsAdmin == "1"
    WriteRegStr HKLM "Software\re3" "Install_Dir" "$INSTDIR"
    WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\re3" "DisplayName" "re3 Game Data"
    WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\re3" "UninstallString" '"$INSTDIR\uninstall.exe"'
    WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\re3" "Publisher" "Tatsh"
    WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\re3" "DisplayVersion" "@CMAKE_PROJECT_VERSION@"
    WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\re3" "URLInfoAbout" "https://tatsh.github.io/re3-installer/"
    WriteRegDWORD HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\re3" "NoModify" 1
    WriteRegDWORD HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\re3" "NoRepair" 1
  ${Else}
    WriteRegStr HKCU "Software\re3" "Install_Dir" "$INSTDIR"
    WriteRegStr HKCU "Software\Microsoft\Windows\CurrentVersion\Uninstall\re3" "DisplayName" "re3 Game Data"
    WriteRegStr HKCU "Software\Microsoft\Windows\CurrentVersion\Uninstall\re3" "UninstallString" '"$INSTDIR\uninstall.exe"'
    WriteRegStr HKCU "Software\Microsoft\Windows\CurrentVersion\Uninstall\re3" "Publisher" "Tatsh"
    WriteRegStr HKCU "Software\Microsoft\Windows\CurrentVersion\Uninstall\re3" "DisplayVersion" "@CMAKE_PROJECT_VERSION@"
    WriteRegStr HKCU "Software\Microsoft\Windows\CurrentVersion\Uninstall\re3" "URLInfoAbout" "https://tatsh.github.io/re3-installer/"
    WriteRegDWORD HKCU "Software\Microsoft\Windows\CurrentVersion\Uninstall\re3" "NoModify" 1
    WriteRegDWORD HKCU "Software\Microsoft\Windows\CurrentVersion\Uninstall\re3" "NoRepair" 1
  ${EndIf}

  ; Calculate and write estimated size
  ${GetSize} "$INSTDIR" "/S=0K" $0 $1 $2
  IntFmt $InstallSize "0x%08X" $0
  ${If} $IsAdmin == "1"
    WriteRegDWORD HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\re3" "EstimatedSize" "$InstallSize"
  ${Else}
    WriteRegDWORD HKCU "Software\Microsoft\Windows\CurrentVersion\Uninstall\re3" "EstimatedSize" "$InstallSize"
  ${EndIf}

  ; Create uninstaller
  WriteUninstaller "$INSTDIR\uninstall.exe"

  InstallEnd:
  ${If} $ErrorOccurred == "1"
    Abort
  ${EndIf}
SectionEnd

; Uninstaller initialization to determine registry root.
Function un.onInit
  ; Check if uninstall info exists in HKLM (admin install)
  ReadRegStr $0 HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\re3" "DisplayName"
  ${If} $0 != ""
    StrCpy $IsAdmin "1"
  ${Else}
    StrCpy $IsAdmin "0"
  ${EndIf}
FunctionEnd

; Uninstaller section.
Section "Uninstall"
  ; Confirm before removing files.
  MessageBox MB_YESNO|MB_ICONQUESTION "This will remove game data files installed by re3-installer from $INSTDIR. Continue?" IDYES +2
    Abort

  ; Check if inventory file exists.
  IfFileExists "$INSTDIR\.re3_installed_files.txt" UseInventory NoInventory
  
  UseInventory:
    ; Use the inventory file to determine files and folders to delete.
    DetailPrint "Removing installed files based on inventory..."
    FileOpen $0 "$INSTDIR\.re3_installed_files.txt" r
    
    ReadFileLoop:
      FileRead $0 $1
      IfErrors DoneReading
      ; Remove trailing newline/carriage return.
      StrCpy $2 $1 -2
      ; Skip empty lines.
      StrCmp $2 "" ReadFileLoop
      ; Skip the uninstaller itself and inventory file.
      StrCmp $2 "$INSTDIR\uninstall.exe" ReadFileLoop
      StrCmp $2 "$INSTDIR\.re3_installed_files.txt" ReadFileLoop
      ; Delete the file if it exists.
      IfFileExists "$2\*.*" 0 +2
        RMDir "$2"
        Goto ReadFileLoop
      Delete "$2"
      Goto ReadFileLoop
    
    DoneReading:
    FileClose $0
    
    ; Remove the inventory file.
    Delete "$INSTDIR\.re3_installed_files.txt"
    
    ; Remove empty parent directories in reverse order.
    RMDir "$INSTDIR\data"
    RMDir "$INSTDIR\models"
    RMDir "$INSTDIR\audio"
    RMDir "$INSTDIR\anim"
    RMDir "$INSTDIR\txd"
    RMDir "$INSTDIR\text"
    RMDir "$INSTDIR\skins"
    RMDir "$INSTDIR\readme"
    RMDir "$INSTDIR\mss"
    RMDir "$INSTDIR\movies"
    RMDir "$INSTDIR\icons"
    RMDir "$INSTDIR\neo"
    RMDir "$INSTDIR\mp3"
    Goto UninstallerCleanup
  
  NoInventory:
    ; Fallback: remove common game data directories if no inventory file.
    DetailPrint "No inventory file found, using fallback removal method..."
    RMDir /r "$INSTDIR\data"
    RMDir /r "$INSTDIR\models"
    RMDir /r "$INSTDIR\audio"
    RMDir /r "$INSTDIR\anim"
    RMDir /r "$INSTDIR\txd"
    RMDir /r "$INSTDIR\text"
    RMDir /r "$INSTDIR\skins"
    RMDir /r "$INSTDIR\readme"
    RMDir /r "$INSTDIR\mss"
    RMDir /r "$INSTDIR\movies"
    RMDir /r "$INSTDIR\icons"
    RMDir /r "$INSTDIR\neo"
    RMDir /r "$INSTDIR\mp3"
    Delete "$INSTDIR\gamecontrollerdb.txt"
  
  UninstallerCleanup:
  
  ; Remove the uninstaller.
  Delete "$INSTDIR\uninstall.exe"

  ; Try to remove the installation directory if it is empty.
  RMDir "$INSTDIR"

  ; Remove registry keys.
  ${If} $IsAdmin == "1"
    DeleteRegKey HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\re3"
    DeleteRegKey HKLM "Software\re3"
  ${Else}
    DeleteRegKey HKCU "Software\Microsoft\Windows\CurrentVersion\Uninstall\re3"
    DeleteRegKey HKCU "Software\re3"
  ${EndIf}

  MessageBox MB_OK "Uninstallation complete. Saved game data and settings were preserved."
SectionEnd
