; NSIS installer script for re3-installer
; This installer will guide users through installing GTA III files for re3

!include "MUI2.nsh"
!include "FileFunc.nsh"
!include "LogicLib.nsh"

; Basic installer information
Name "re3-installer"
OutFile "re3-installer-setup-@CMAKE_PROJECT_VERSION@.exe"
InstallDir "$APPDATA\re3"
InstallDirRegKey HKCU "Software\re3-installer" "Install_Dir"
RequestExecutionLevel highest

; Variables
Var Disc1Path
Var Disc2Path
Var ErrorOccurred
Var InstallSize
Var Disc1TextField
Var Disc2TextField
Var IsAdmin

; MUI Settings
!define MUI_ABORTWARNING
!define MUI_ICON "${NSISDIR}\Contrib\Graphics\Icons\modern-install.ico"
!define MUI_UNICON "${NSISDIR}\Contrib\Graphics\Icons\modern-uninstall.ico"

; Welcome page
!insertmacro MUI_PAGE_WELCOME

; License page
!insertmacro MUI_PAGE_LICENSE "@CMAKE_SOURCE_DIR@\LICENSE.txt"

; Custom page for Disc selection
Page custom DiscSelectionPage DiscSelectionPageLeave

; Installation directory page
!insertmacro MUI_PAGE_DIRECTORY

; Installation page
!insertmacro MUI_PAGE_INSTFILES

; Finish page
!insertmacro MUI_PAGE_FINISH

; Uninstaller pages
!insertmacro MUI_UNPAGE_CONFIRM
!insertmacro MUI_UNPAGE_INSTFILES

; Languages
!insertmacro MUI_LANGUAGE "English"

; Initialization function to set installation directory based on admin status
Function .onInit
  UserInfo::GetAccountType
  Pop $0
  ${If} $0 == "Admin"
    ; Running as admin, use Program Files
    StrCpy $IsAdmin "1"
    ; Check if there's a previous installation in HKLM
    StrCpy $1 ""
    ReadRegStr $1 HKLM "Software\re3-installer" "Install_Dir"
    ${If} $1 != ""
      StrCpy $INSTDIR $1
    ${Else}
      StrCpy $INSTDIR "$PROGRAMFILES\re3"
    ${EndIf}
  ${Else}
    ; Running as user, use AppData
    StrCpy $IsAdmin "0"
    ; Check if there's a previous installation in HKCU
    StrCpy $1 ""
    ReadRegStr $1 HKCU "Software\re3-installer" "Install_Dir"
    ${If} $1 != ""
      StrCpy $INSTDIR $1
    ${Else}
      StrCpy $INSTDIR "$APPDATA\re3"
    ${EndIf}
  ${EndIf}
FunctionEnd

; Custom page for disc selection
Function DiscSelectionPage
  nsDialogs::Create 1018
  Pop $0
  ${If} $0 == error
    Abort
  ${EndIf}

  ; Disc 1 section
  ${NSD_CreateLabel} 0 0 100% 12u "Disc 1 (ISO file or directory):"
  Pop $0

  ${NSD_CreateText} 0 15u 100% 12u "$Disc1Path"
  Pop $Disc1TextField

  ${NSD_CreateButton} 0 30u 49% 14u "Browse File..."
  Pop $1
  ${NSD_OnClick} $1 Disc1BrowseFile

  ${NSD_CreateButton} 51% 30u 49% 14u "Browse Folder..."
  Pop $2
  ${NSD_OnClick} $2 Disc1BrowseFolder

  ; Disc 2 section
  ${NSD_CreateLabel} 0 55u 100% 12u "Disc 2 (ISO file or directory with Audio folder):"
  Pop $0

  ${NSD_CreateText} 0 70u 100% 12u "$Disc2Path"
  Pop $Disc2TextField

  ${NSD_CreateButton} 0 85u 49% 14u "Browse File..."
  Pop $3
  ${NSD_OnClick} $3 Disc2BrowseFile

  ${NSD_CreateButton} 51% 85u 49% 14u "Browse Folder..."
  Pop $4
  ${NSD_OnClick} $4 Disc2BrowseFolder

  nsDialogs::Show
FunctionEnd

Function Disc1BrowseFile
  nsDialogs::SelectFileDialog open "$Disc1Path" "ISO Files (*.iso)|*.iso|All Files (*.*)|*.*"
  Pop $0
  ${If} $0 != ""
    StrCpy $Disc1Path $0
    ${NSD_SetText} $Disc1TextField $Disc1Path
  ${EndIf}
FunctionEnd

Function Disc1BrowseFolder
  nsDialogs::SelectFolderDialog "Select Disc 1 Directory" "$Disc1Path"
  Pop $0
  ${If} $0 != ""
    StrCpy $Disc1Path $0
    ${NSD_SetText} $Disc1TextField $Disc1Path
  ${EndIf}
FunctionEnd

Function Disc2BrowseFile
  nsDialogs::SelectFileDialog open "$Disc2Path" "ISO Files (*.iso)|*.iso|All Files (*.*)|*.*"
  Pop $0
  ${If} $0 != ""
    StrCpy $Disc2Path $0
    ${NSD_SetText} $Disc2TextField $Disc2Path
  ${EndIf}
FunctionEnd

Function Disc2BrowseFolder
  nsDialogs::SelectFolderDialog "Select Disc 2 Directory" "$Disc2Path"
  Pop $0
  ${If} $0 != ""
    StrCpy $Disc2Path $0
    ${NSD_SetText} $Disc2TextField $Disc2Path
  ${EndIf}
FunctionEnd

Function DiscSelectionPageLeave
  ${NSD_GetText} $Disc1TextField $Disc1Path
  ${NSD_GetText} $Disc2TextField $Disc2Path

  ${If} $Disc1Path == ""
    MessageBox MB_OK|MB_ICONEXCLAMATION "Please select a path for Disc 1."
    Abort
  ${EndIf}

  ${If} $Disc2Path == ""
    MessageBox MB_OK|MB_ICONEXCLAMATION "Please select a path for Disc 2."
    Abort
  ${EndIf}

  IfFileExists "$Disc1Path" +3 0
    MessageBox MB_OK|MB_ICONEXCLAMATION "The specified path for Disc 1 does not exist."
    Abort

  IfFileExists "$Disc2Path" +3 0
    MessageBox MB_OK|MB_ICONEXCLAMATION "The specified path for Disc 2 does not exist."
    Abort
FunctionEnd

; Installation section
Section "Install" SecInstall
  StrCpy $ErrorOccurred "0"

  ; Check if installation directory already exists with content
  IfFileExists "$INSTDIR\*.*" 0 +3
    MessageBox MB_YESNO|MB_ICONQUESTION "The installation directory already contains files. Continue anyway? (Not recommended)" IDYES +2
    Abort

  ; Create installation directory
  CreateDirectory "$INSTDIR"

  SetOutPath "$TEMP\re3-installer-temp"

  ; Extract re3-installer.exe to temporary directory
  File "@CMAKE_BINARY_DIR@\src\re3-installer.exe"

  ; Extract required DLLs from the prefix/bin directory
  ; Note: These files are optional and may not exist depending on build configuration
  File /nonfatal "@CMAKE_INSTALL_PREFIX@\bin\libcdio-*.dll"
  File /nonfatal "@CMAKE_INSTALL_PREFIX@\bin\libiso9660-*.dll"
  File /nonfatal "@CMAKE_INSTALL_PREFIX@\bin\libunshield-*.dll"
  File /nonfatal "@CMAKE_INSTALL_PREFIX@\bin\libiconv-*.dll"
  File /nonfatal "@CMAKE_INSTALL_PREFIX@\bin\libwinpthread-*.dll"
  File /nonfatal "@CMAKE_INSTALL_PREFIX@\bin\zlib*.dll"

  DetailPrint "Running re3-installer..."
  DetailPrint "Disc 1: $Disc1Path"
  DetailPrint "Disc 2: $Disc2Path"
  DetailPrint "Install Directory: $INSTDIR"

  ; Execute re3-installer.exe with the provided paths
  ClearErrors
  nsExec::ExecToLog '"$TEMP\re3-installer-temp\re3-installer.exe" "$Disc1Path" "$Disc2Path" "$INSTDIR"'
  Pop $0

  ; Check if the installation was successful
  ${If} $0 != 0
    StrCpy $ErrorOccurred "1"
    DetailPrint "Installation failed with error code $0. Cleaning up..."
    MessageBox MB_OK|MB_ICONEXCLAMATION "Installation failed with error code $0. Installation directory will be cleaned if it was created by this installer."
    ; Only remove the directory if we created it (it should be empty except for what we tried to install)
    RMDir "$INSTDIR"
    Goto InstallEnd
  ${EndIf}

  DetailPrint "Installation completed successfully."

  ; Clean up temporary files
  Delete "$TEMP\re3-installer-temp\re3-installer.exe"
  Delete "$TEMP\re3-installer-temp\*.dll"
  RMDir "$TEMP\re3-installer-temp"

  ; Write registry keys for uninstaller
  ${If} $IsAdmin == "1"
    WriteRegStr HKLM "Software\re3-installer" "Install_Dir" "$INSTDIR"
    WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\re3-installer" "DisplayName" "re3-installer"
    WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\re3-installer" "UninstallString" '"$INSTDIR\uninstall.exe"'
    WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\re3-installer" "Publisher" "Tatsh"
    WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\re3-installer" "DisplayVersion" "@CMAKE_PROJECT_VERSION@"
    WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\re3-installer" "URLInfoAbout" "https://tatsh.github.io/re3-installer/"
    WriteRegDWORD HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\re3-installer" "NoModify" 1
    WriteRegDWORD HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\re3-installer" "NoRepair" 1
  ${Else}
    WriteRegStr HKCU "Software\re3-installer" "Install_Dir" "$INSTDIR"
    WriteRegStr HKCU "Software\Microsoft\Windows\CurrentVersion\Uninstall\re3-installer" "DisplayName" "re3-installer"
    WriteRegStr HKCU "Software\Microsoft\Windows\CurrentVersion\Uninstall\re3-installer" "UninstallString" '"$INSTDIR\uninstall.exe"'
    WriteRegStr HKCU "Software\Microsoft\Windows\CurrentVersion\Uninstall\re3-installer" "Publisher" "Tatsh"
    WriteRegStr HKCU "Software\Microsoft\Windows\CurrentVersion\Uninstall\re3-installer" "DisplayVersion" "@CMAKE_PROJECT_VERSION@"
    WriteRegStr HKCU "Software\Microsoft\Windows\CurrentVersion\Uninstall\re3-installer" "URLInfoAbout" "https://tatsh.github.io/re3-installer/"
    WriteRegDWORD HKCU "Software\Microsoft\Windows\CurrentVersion\Uninstall\re3-installer" "NoModify" 1
    WriteRegDWORD HKCU "Software\Microsoft\Windows\CurrentVersion\Uninstall\re3-installer" "NoRepair" 1
  ${EndIf}

  ; Calculate and write estimated size
  ${GetSize} "$INSTDIR" "/S=0K" $0 $1 $2
  IntFmt $InstallSize "0x%08X" $0
  ${If} $IsAdmin == "1"
    WriteRegDWORD HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\re3-installer" "EstimatedSize" "$InstallSize"
  ${Else}
    WriteRegDWORD HKCU "Software\Microsoft\Windows\CurrentVersion\Uninstall\re3-installer" "EstimatedSize" "$InstallSize"
  ${EndIf}

  ; Create uninstaller
  WriteUninstaller "$INSTDIR\uninstall.exe"

  InstallEnd:
  ${If} $ErrorOccurred == "1"
    Abort
  ${EndIf}
SectionEnd

; Uninstaller initialization to determine registry root
Function un.onInit
  ; Check if uninstall info exists in HKLM (admin install)
  ReadRegStr $0 HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\re3-installer" "DisplayName"
  ${If} $0 != ""
    StrCpy $IsAdmin "1"
  ${Else}
    StrCpy $IsAdmin "0"
  ${EndIf}
FunctionEnd

; Uninstaller section
Section "Uninstall"
  ; Confirm before removing files
  MessageBox MB_YESNO|MB_ICONQUESTION "This will remove all game data files from $INSTDIR. Continue?" IDYES +2
    Abort

  ; Remove the uninstaller
  Delete "$INSTDIR\uninstall.exe"

  ; Remove common game data directories that re3-installer creates
  RMDir /r "$INSTDIR\data"
  RMDir /r "$INSTDIR\models"
  RMDir /r "$INSTDIR\audio"
  RMDir /r "$INSTDIR\Audio"
  RMDir /r "$INSTDIR\anim"
  RMDir /r "$INSTDIR\txd"

  ; Try to remove the installation directory if it is empty
  RMDir "$INSTDIR"

  ; Remove registry keys
  ${If} $IsAdmin == "1"
    DeleteRegKey HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\re3-installer"
    DeleteRegKey HKLM "Software\re3-installer"
  ${Else}
    DeleteRegKey HKCU "Software\Microsoft\Windows\CurrentVersion\Uninstall\re3-installer"
    DeleteRegKey HKCU "Software\re3-installer"
  ${EndIf}

  MessageBox MB_OK "Uninstallation complete. If the installation directory still exists, it may contain user-created files that were not removed."
SectionEnd
